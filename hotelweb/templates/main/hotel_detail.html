{% extends "base.html" %}

{% block title %}{{ hotel.name }} - HotelWeb{% endblock %}

{% block breadcrumb %}
<div class="container">
    <nav aria-label="breadcrumb" class="py-1">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">{{ t('home') }}</a></li>
            {% if breadcrumb.from_search %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.search', **breadcrumb.search_params) }}">{{ t('search_results') }}</a>
            </li>
            {% elif breadcrumb.from_brand %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.brands') }}">{{ t('brands') }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.brand_detail', brand_id=breadcrumb.brand_id) }}">{{ hotel.brand.name }}</a>
            </li>
            {% elif breadcrumb.from_city %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.destinations') }}">{{ t('destinations') }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.city_hotels', city_name=breadcrumb.city_name) }}">{{ breadcrumb.city_name }}</a>
            </li>
            {% elif breadcrumb.from_destinations %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.destinations') }}">{{ t('destinations') }}</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active">{{ hotel.name }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
{% set reviews_per_row = 3 %}
{% set max_rows = 2 %}
{% set max_visible = reviews_per_row * max_rows %}
<div class="row align-items-end" 
     data-hotel-detail='{"totalReviews": {{ hotel.reviews|length if hotel.reviews else 0 }}, "visibleReviews": {{ max_visible }}, "lat": {% if hotel.latitude %}{{ hotel.latitude }}{% else %}null{% endif %}, "lng": {% if hotel.longitude %}{{ hotel.longitude }}{% else %}null{% endif %}}'>
    <div class="col-md-6">
        <img src="{{ hotel.image_url }}" class="img-fluid rounded shadow w-100 hotel-main-image"
            alt="{{ hotel.name }}" id="hotel-main-image">
</div>

    <div class="col-md-6 d-flex flex-column hotel-info-column" id="hotel-info-column">
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h1 class="display-5 fw-bold mb-0">{{ hotel.name }}</h1>
                {% if current_user.is_authenticated %}
                <button type="button" class="btn-favorite {% if is_favorited %}favorited{% endif %}" 
                        data-hotel-id="{{ hotel.id }}"
                        aria-label="{% if is_favorited %}Remove from favorites{% else %}Add to favorites{% endif %}">
                    <i class="bi {% if is_favorited %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                </button>
                {% endif %}
            </div>
            <p class="text-muted mb-2"><i class="bi bi-geo-alt-fill"></i> {{ hotel.address }}, {{ hotel.city }}</p>
            <div class="mb-3">
                <div class="hotel-brand-with-stars">
                    <a href="{{ url_for('main.brand_detail', brand_id=hotel.brand.id) }}" class="brand-badge" style="background-color: {{ hotel.brand.logo_color }};">{{ hotel.brand.name }}</a>
                    <span class="hotel-brand-stars">
                        {% for _ in range(hotel.stars) %}<i class="bi bi-star-fill"></i>{% endfor %}
            </span>
        </div>
    </div>

            {% if hotel.reviews %}
            {% set avg_rating = (hotel.reviews|sum(attribute='rating') / hotel.reviews|length) %}
            <div class="mb-3">
                <div class="d-flex align-items-center gap-2">
                    <div class="d-flex align-items-center">
                        {% for i in range(5) %}
                            {% if i < avg_rating|int %}
                                <i class="bi bi-heart-fill text-danger" aria-hidden="true"></i>
                            {% elif i < avg_rating|round(1)|int %}
                                <i class="bi bi-heart-half text-danger" aria-hidden="true"></i>
                            {% else %}
                                <i class="bi bi-heart text-danger" aria-hidden="true"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                    <span class="text-muted">({{ hotel.reviews|length }} {{ t('reviews') if hotel.reviews|length != 1 else t('review') }})</span>
                </div>
            </div>
            {% endif %}
            
            {% if hotel.description %}
            <div class="mb-3">
                <p class="text-muted mb-0 hotel-description-text">
                    {{ hotel.description }}
                </p>
            </div>
            {% endif %}
        </div>

        <div class="mt-auto">
            {% if hotel.latitude and hotel.longitude %}
            <div class="card border-0 shadow-sm hotel-map-card">
                <div id="hotel-map" class="hotel-map-container"></div>
            </div>
            {% else %}
            <div class="card border-0 shadow-sm d-flex align-items-center justify-content-center hotel-map-unavailable">
                <div class="text-center text-muted">
                    <i class="bi bi-map map-icon-large"></i>
                    <p class="small mb-0 mt-2">{{ t('map_unavailable') }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Room Types Section - Display First -->
<section class="mt-4 mb-4" aria-labelledby="rooms-heading">
    <h2 id="rooms-heading" class="h4 fw-bold mb-4">{{ t('room_types') }}</h2>
    <div class="row g-4">
            {% for rt in hotel.room_types %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-effect">
                {% if rt.image_url %}
                <img src="{{ rt.image_url }}" class="card-img-top room-type-image" alt="{{ rt.name }}">
                {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center room-type-placeholder">
                    <i class="bi bi-image text-muted room-type-placeholder-icon"></i>
                </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1 me-3">
                            <h3 class="h5 fw-bold mb-1">
                                <a href="{{ url_for('main.roomtype_detail', roomtype_id=rt.id) }}{% if breadcrumb.from_search %}?from=search{% if breadcrumb.search_params.check_in %}&check_in={{ breadcrumb.search_params.check_in }}{% endif %}{% if breadcrumb.search_params.check_out %}&check_out={{ breadcrumb.search_params.check_out }}{% endif %}{% elif breadcrumb.from_brand %}?from=brand{% elif breadcrumb.from_city %}?from=city&city_name={{ breadcrumb.city_name }}{% elif breadcrumb.from_destinations %}?from=destinations{% endif %}" class="text-decoration-none text-dark">
                                    {{ rt.name }}
                                </a>
                            </h3>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-people me-1" aria-hidden="true"></i>{{ rt.capacity }} {{ t('guests') if rt.capacity > 1 else t('guest') }}
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-star me-1" aria-hidden="true"></i>{{ rt.amenities|length }} {{ t('amenities') if rt.amenities|length != 1 else t('amenity') }}
                                </span>
                            </div>
                </div>
                <div class="text-end">
                            <div class="text-success fw-bold fs-4 mb-0">${{ "{:,.0f}".format(rt.price_per_night) }}</div>
                            <small class="text-muted">{{ t('per_night') }}</small>
                            {% if room_availability and rt.id in room_availability %}
                            <div class="mt-1">
                                {% set avail = room_availability[rt.id] %}
                                {% if avail == 0 %}
                                <span class="availability-badge-small sold-out">{{ t('sold_out') }}</span>
                                {% elif avail < 5 %}
                                <span class="availability-badge-small low-stock">{{ t('only_left') }} {{ avail }} {{ t('left') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if room_availability and rt.id in room_availability and room_availability[rt.id] == 0 %}
                    <a href="{{ url_for('main.roomtype_detail', roomtype_id=rt.id) }}{% if breadcrumb.from_search %}?from=search{% if breadcrumb.search_params.check_in %}&check_in={{ breadcrumb.search_params.check_in }}{% endif %}{% if breadcrumb.search_params.check_out %}&check_out={{ breadcrumb.search_params.check_out }}{% endif %}{% elif breadcrumb.from_brand %}?from=brand{% elif breadcrumb.from_city %}?from=city&city_name={{ breadcrumb.city_name }}{% elif breadcrumb.from_destinations %}?from=destinations{% endif %}" class="btn btn-secondary w-100 mt-auto sold-out-btn">
                        {{ t('sold_out') }}
                    </a>
                    {% else %}
                    <a href="{{ url_for('main.roomtype_detail', roomtype_id=rt.id) }}{% if breadcrumb.from_search %}?from=search{% if breadcrumb.search_params.check_in %}&check_in={{ breadcrumb.search_params.check_in }}{% endif %}{% if breadcrumb.search_params.check_out %}&check_out={{ breadcrumb.search_params.check_out }}{% endif %}{% elif breadcrumb.from_brand %}?from=brand{% elif breadcrumb.from_city %}?from=city&city_name={{ breadcrumb.city_name }}{% elif breadcrumb.from_destinations %}?from=destinations{% endif %}" class="btn btn-primary w-100 mt-auto">
                        {{ t('view_details') }}
                        <i class="bi bi-arrow-right ms-1" aria-hidden="true"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Guest Reviews Section - Display After Room Types -->
<section class="mt-5 mb-4" aria-labelledby="reviews-heading">
    <h2 id="reviews-heading" class="h4 fw-bold mb-4">{{ t('guest_reviews') }}</h2>
    {% if not hotel.reviews %}
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-chat-dots text-muted empty-reviews-icon"></i>
            <p class="text-muted mt-3 mb-0">{{ t('no_reviews_yet_first') }}</p>
        </div>
    </div>
    {% else %}
    {% set reviews_list = hotel.reviews|list %}
    <div class="reviews-container">
        <div class="row g-3 reviews-row" id="reviews-display">
            {% for review in reviews_list %}
            <div class="col-md-6 col-lg-4 review-item {% if loop.index > max_visible %}review-hidden{% endif %}">
                <div class="card h-100 shadow-sm border-0 review-card-bg">
            <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold mb-0">{{ review.author.username }}</h6>
                            <div class="text-danger">
                                {% for _ in range(review.rating) %}<i class="bi bi-heart-fill" aria-hidden="true"></i>{% endfor %}
                                {% for _ in range(5 - review.rating) %}<i class="bi bi-heart" aria-hidden="true"></i>{% endfor %}
                            </div>
                        </div>
                        <p class="card-text small mb-2">"{{ review.comment }}"</p>
                        <small class="text-muted">{{ review.created_at.strftime('%Y-%m-%d') }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if reviews_list|length > max_visible %}
        <div class="text-center mt-4">
            <button type="button" class="btn btn-outline-secondary" id="toggle-reviews-btn">
                <span id="toggle-reviews-text">{{ t('show_more_reviews') }} ({{ reviews_list|length - max_visible }} {{ t('more_reviews') }})</span>
                <i class="bi bi-chevron-down ms-2" id="toggle-reviews-icon"></i>
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}
</section>



<!-- Recommended Hotels Section -->
{% if recommended_hotels %}
<section class="mt-5 mb-4" aria-labelledby="recommended-heading">
    <h2 id="recommended-heading" class="h4 fw-bold mb-4">{{ t('you_might_also_like') }}</h2>
    <div class="row g-4">
        {% for rec_hotel in recommended_hotels %}
        <div class="col-md-6 col-lg-4">
            <div class="card hotel-card">
                <div class="position-relative">
                    {% if rec_hotel.image_url %}
                    <img src="{{ rec_hotel.image_url }}" class="hotel-card-img" alt="{{ rec_hotel.name }}">
                    {% else %}
                    <div class="hotel-card-img bg-light d-flex align-items-center justify-content-center">
                        <i class="bi bi-image text-muted room-type-placeholder-icon"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="hotel-card-body">
                    <h5 class="hotel-card-title">
                        <a href="{{ url_for('main.hotel_detail', hotel_id=rec_hotel.id) }}" class="text-decoration-none text-dark">
                            {{ rec_hotel.name }}
                        </a>
                    </h5>
                    <p class="hotel-card-location">
                        <i class="bi bi-geo-alt-fill"></i> {{ rec_hotel.address }}, {{ rec_hotel.city }}
                    </p>
                    <p class="hotel-card-description">{{ rec_hotel.description }}</p>
                    <div class="hotel-card-footer">
                        <div class="hotel-card-footer-left">
                            <div class="hotel-brand-with-stars">
                                <a href="{{ url_for('main.brand_detail', brand_id=rec_hotel.brand.id) }}" class="hotel-brand-badge" style="background-color: {{ rec_hotel.brand.logo_color }};">{{ rec_hotel.brand.name }}</a>
                                <span class="hotel-brand-stars">
                                    {% for _ in range(rec_hotel.stars) %}<i class="bi bi-star-fill"></i>{% endfor %}
                                </span>
                            </div>
                            {% if rec_hotel.reviews %}
                            {% set rec_avg_rating = (rec_hotel.reviews|sum(attribute='rating') / rec_hotel.reviews|length) %}
                            <div class="hotel-card-rating">
                                <div class="hotel-card-rating-hearts">
                                    {% for i in range(5) %}
                                        {% if i < rec_avg_rating|int %}
                                            <i class="bi bi-heart-fill"></i>
                                        {% elif i < rec_avg_rating|round(1)|int %}
                                            <i class="bi bi-heart-half"></i>
                                        {% else %}
                                            <i class="bi bi-heart"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="hotel-card-rating-score">{{ "%.1f"|format(rec_avg_rating) }}</span>
                                <span class="hotel-card-rating-count">({{ rec_hotel.reviews|length }} {{ t('reviews') if rec_hotel.reviews|length != 1 else t('review') }})</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="hotel-card-footer-right">
                            <a href="{{ url_for('main.hotel_detail', hotel_id=rec_hotel.id) }}" class="hotel-card-btn hotel-card-btn-primary">VIEW DETAILS</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
</div>
</section>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/hotel_detail.js') }}"></script>
<script src="{{ url_for('static', filename='js/favorites.js') }}"></script>
{% endblock %}
