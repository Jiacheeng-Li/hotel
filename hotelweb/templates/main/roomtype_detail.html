{% extends "base.html" %}

{% block title %}{{ roomtype.name }} - HotelWeb{% endblock %}

{% block breadcrumb %}
<div class="container">
    <nav aria-label="breadcrumb" class="py-1">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">{{ t('home') }}</a></li>
            {% if breadcrumb.from_search %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.search', **breadcrumb.search_params) }}">{{ t('search_results') }}</a>
            </li>
            {% elif breadcrumb.from_brand %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.brands') }}">{{ t('brands') }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.brand_detail', brand_id=breadcrumb.brand_id) }}">{{ roomtype.hotel.brand.name }}</a>
            </li>
            {% elif breadcrumb.from_city %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.destinations') }}">{{ t('destinations') }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.city_hotels', city_name=breadcrumb.city_name) }}">{{ breadcrumb.city_name }}</a>
            </li>
            {% elif breadcrumb.from_destinations %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.destinations') }}">{{ t('destinations') }}</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item"><a href="{{ url_for('main.hotel_detail', hotel_id=roomtype.hotel.id) }}{% if breadcrumb.from_city %}?from=city&city_name={{ breadcrumb.city_name }}{% elif breadcrumb.from_search %}?from=search{% elif breadcrumb.from_brand %}?from=brand{% elif breadcrumb.from_destinations %}?from=destinations{% endif %}">{{ roomtype.hotel.name }}</a></li>
            <li class="breadcrumb-item active">{{ roomtype.name }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2 class="text-primary fw-bold">{{ roomtype.name }}</h2>
        <p class="text-muted fs-5">{{ roomtype.hotel.name }} <a href="{{ url_for('main.brand_detail', brand_id=roomtype.hotel.brand.id) }}" class="brand-badge ms-2" style="background-color: {{ roomtype.hotel.brand.logo_color }};">{{ roomtype.hotel.brand.name }}</a></p>

        <!-- Room Image -->
        <div class="mt-4">
            <div class="card border-0 shadow-sm overflow-hidden roomtype-image-card">
                {% if roomtype.image_url %}
                <img src="{{ roomtype.image_url }}" class="img-fluid w-100 roomtype-main-image" alt="{{ roomtype.name }}">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center roomtype-placeholder">
                    <div class="text-center text-muted">
                        <i class="bi bi-image roomtype-placeholder-icon"></i>
                        <p class="mt-2 mb-0">{{ t('no_image_available') }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Room Description -->
        <div class="mt-4">
            <div class="card border-0 shadow-sm roomtype-description-card">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3 roomtype-description-title">{{ t('room_description') }}</h5>
                    <p class="text-muted mb-0 roomtype-description-text">{{ roomtype.description or t('experience_comfort_style') }}</p>
                </div>
            </div>
        </div>

        <!-- Included Amenities -->
        <section class="mb-4 mt-4" aria-labelledby="amenities-heading">
            <h2 id="amenities-heading" class="h5 fw-bold mb-3">
                <i class="bi bi-grid-fill me-2 text-primary" aria-hidden="true"></i>{{ t('included_amenities') }}
                <span class="badge text-white ms-2 badge-amenities-count">{{ roomtype.amenities|length }} {{ t('amenities') if roomtype.amenities|length != 1 else t('amenity') }}</span>
            </h2>
            {% if roomtype.amenities %}
            <div class="row g-3">
                {% for amenity in roomtype.amenities %}
                {% set amenity_icons = {
                    'Free Wi-Fi': 'bi-wifi',
                    'Swimming Pool': 'bi-water',
                    'Gym': 'bi-activity',
                    'Spa': 'bi-flower1',
                    'Restaurant': 'bi-cup-hot',
                    'Bar': 'bi-cup-straw',
                    'Room Service': 'bi-bell',
                    'Parking': 'bi-p-square',
                    'Airport Shuttle': 'bi-bus-front',
                    'Pet Friendly': 'bi-heart',
                    'Conference Room': 'bi-people',
                    'Kids Club': 'bi-emoji-smile',
                    'Ocean View': 'bi-eye',
                    'Smart TV': 'bi-tv',
                    'Mini Bar': 'bi-cup',
                    'Rooftop Terrace': 'bi-building',
                    'Yoga Studio': 'bi-heart-pulse'
                } %}
                {% set icon_class = amenity_icons.get(amenity.name, 'bi-check-circle') %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm bg-light hover-effect amenity-card">
                        <div class="card-body d-flex align-items-center p-3">
                            <i class="bi {{ icon_class }} text-primary fs-5 me-3" aria-hidden="true"></i>
                            <span class="fw-bold text-primary">{{ amenity.name }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">{{ t('no_amenities_listed') }}</p>
            {% endif %}
        </section>
    </div>

    <div class="col-md-4">
        <div class="card shadow-lg border-0 sticky-top roomtype-booking-card">
            <div class="card-body p-4">
                <div class="text-center mb-3">
                    {% set tax_rate = 0.10 %}
                    {% set service_fee_rate = 0.05 %}
                    {% set price_per_night_float = roomtype.price_per_night|float %}
                    {% set price_with_tax = price_per_night_float * (1 + tax_rate + service_fee_rate) %}
                    <h3 class="text-success fw-bold mb-0" id="price-per-night">${{ "{:,.0f}".format(price_per_night_float) }}</h3>
                    <small class="text-muted">{{ t('per_night') }} <span class="text-muted price-with-tax-text" id="price-with-tax">${{ "{:,.2f}".format(price_with_tax) }} {{ t('incl_tax') }}</span></small>
                    
                    {% if available_rooms is defined %}
                    <div class="mt-2">
                        {% if available_rooms == 0 %}
                        <span class="availability-badge sold-out">{{ t('sold_out') }}</span>
                        {% elif available_rooms < 5 %}
                        <span class="availability-badge low-stock">{{ t('only_left') }} {{ available_rooms }} {{ t('left') }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                {% if current_user.is_authenticated and estimated_points_per_night > 0 %}
                <div class="points-display-container">
                    <span class="points-display-text">{{ t('earn_points_per_night') }} <span class="points-display-number">{{ "{:,}".format(estimated_points_per_night) }}</span> {{ t('points_per_night') }}</span>
                </div>
                {% endif %}

                <hr>

                <form action="{{ url_for('main.booking_confirm', roomtype_id=roomtype.id) }}" method="get">
                    {% set default_rooms = request.args.get('rooms_needed', 1) %}

                    <div class="mb-3">
                        <label for="check_in" class="form-label fw-bold">{{ t('check_in') }}</label>
                        <input type="date" name="check_in" id="check_in" class="form-control" required value="{{ default_check_in }}" min="{{ today }}" aria-label="Check-in date">
                    </div>
                    <div class="mb-3">
                        <label for="check_out" class="form-label fw-bold">{{ t('check_out') }}</label>
                        <input type="date" name="check_out" id="check_out" class="form-control" required value="{{ default_check_out }}" min="{{ today }}" aria-label="Check-out date">
                    </div>
                    <div class="mb-3">
                        <label for="rooms_needed" class="form-label fw-bold">{{ t('rooms_required') }}</label>
                        <input type="number" name="rooms_needed" id="rooms_needed" class="form-control" min="1" value="{{ default_rooms }}" required aria-label="Number of rooms needed">
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="breakfast_included" id="breakfast_included" value="1">
                            <label class="form-check-label d-flex justify-content-between align-items-center" for="breakfast_included">
                                <strong>{{ t('add_breakfast') }}</strong>
                                <span class="small text-muted ms-2">${{ "{:,.2f}".format(breakfast_price_per_room) }} {{ t('per_room_per_stay') }}</span>
                            </label>
                        </div>
                    </div>

                    {% if current_user.is_authenticated %}
                    <div class="d-grid">
                        {% if available_rooms is defined and available_rooms == 0 %}
                        <button type="button" class="btn btn-lg fw-bold text-white btn-sold-out" disabled aria-label="Room is sold out">{{ t('sold_out') }}</button>
                        {% else %}
                        <button type="submit" class="btn btn-primary btn-lg fw-bold" aria-label="Confirm your booking">{{ t('confirm_booking') }}</button>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-secondary text-center">
                        {{ t('please_login_to_book') }} <a href="{{ url_for('auth.login', next=request.url) }}" class="fw-bold">{{ t('login_to_book') }}</a> {{ t('to_book_and_earn') }}
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<div class="roomtype-data" 
     data-base-price="{{ roomtype.price_per_night|float }}"
     data-breakfast-price="{{ breakfast_price_per_room|float }}"
     data-base-points="{{ estimated_points_per_night }}"
     data-multiplier="{{ current_user.get_points_multiplier() if current_user.is_authenticated else 1 }}"
     style="display: none;"></div>
<script src="{{ url_for('static', filename='js/roomtype_detail.js') }}"></script>
{% endblock %}
