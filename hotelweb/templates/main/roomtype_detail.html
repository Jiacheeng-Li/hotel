{% extends "base.html" %}

{% block title %}{{ roomtype.name }} - HotelWeb{% endblock %}

{% block breadcrumb %}
<div class="container">
    <nav aria-label="breadcrumb" class="py-1">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
            {% if breadcrumb.from_search %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.search', **breadcrumb.search_params) }}">Search Results</a>
            </li>
            {% elif breadcrumb.from_brand %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.brands') }}">Brands</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.brand_detail', brand_id=breadcrumb.brand_id) }}">{{ roomtype.hotel.brand.name }}</a>
            </li>
            {% elif breadcrumb.from_destinations %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.destinations') }}">Destinations</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item"><a href="{{ url_for('main.hotel_detail', hotel_id=roomtype.hotel.id) }}">{{ roomtype.hotel.name }}</a></li>
            <li class="breadcrumb-item active">{{ roomtype.name }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2 class="text-primary fw-bold">{{ roomtype.name }}</h2>
        <p class="text-muted fs-5">{{ roomtype.hotel.name }} <span class="badge bg-secondary ms-2">{{ roomtype.hotel.brand.name }}</span></p>

        <!-- Room Image -->
        <div class="mt-4">
            <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: 16px;">
                {% if roomtype.image_url %}
                <img src="{{ roomtype.image_url }}" class="img-fluid w-100" style="height: 450px; object-fit: cover;" alt="{{ roomtype.name }}">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 450px;">
                    <div class="text-center text-muted">
                        <i class="bi bi-image" style="font-size: 3rem;"></i>
                        <p class="mt-2 mb-0">No image available</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Room Description -->
        <div class="mt-4">
            <div class="card border-0 shadow-sm" style="border-radius: 16px; background: #f8fafc;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3" style="color: #1a1a1a; font-size: 1.25rem;">Room Description</h5>
                    <p class="text-muted mb-0" style="line-height: 1.8; font-size: 0.95rem;">{{ roomtype.description or 'Experience comfort and style in this beautifully designed room.' }}</p>
                </div>
            </div>
        </div>

        <!-- Included Amenities -->
        <section class="mb-4 mt-4" aria-labelledby="amenities-heading">
            <h2 id="amenities-heading" class="h5 fw-bold mb-3">
                <i class="bi bi-grid-fill me-2 text-primary" aria-hidden="true"></i>Included Amenities
                <span class="badge text-white ms-2" style="background-color: #1e3a8a;">{{ roomtype.amenities|length }} amenit{{ 'ies' if roomtype.amenities|length != 1 else 'y' }}</span>
            </h2>
            {% if roomtype.amenities %}
            <div class="row g-3">
                {% for amenity in roomtype.amenities %}
                {% set amenity_icons = {
                    'Free Wi-Fi': 'bi-wifi',
                    'Swimming Pool': 'bi-water',
                    'Gym': 'bi-activity',
                    'Spa': 'bi-flower1',
                    'Restaurant': 'bi-cup-hot',
                    'Bar': 'bi-cup-straw',
                    'Room Service': 'bi-bell',
                    'Parking': 'bi-p-square',
                    'Airport Shuttle': 'bi-bus-front',
                    'Pet Friendly': 'bi-heart',
                    'Conference Room': 'bi-people',
                    'Kids Club': 'bi-emoji-smile',
                    'Ocean View': 'bi-eye',
                    'Smart TV': 'bi-tv',
                    'Mini Bar': 'bi-cup',
                    'Rooftop Terrace': 'bi-building',
                    'Yoga Studio': 'bi-heart-pulse'
                } %}
                {% set icon_class = amenity_icons.get(amenity.name, 'bi-check-circle') %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm bg-light hover-effect" style="border-left: 4px solid var(--primary-color);">
                        <div class="card-body d-flex align-items-center p-3">
                            <i class="bi {{ icon_class }} text-primary fs-5 me-3" aria-hidden="true"></i>
                            <span class="fw-bold text-primary">{{ amenity.name }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">No amenities listed for this room type.</p>
            {% endif %}
        </section>
    </div>

    <div class="col-md-4">
        <div class="card shadow-lg border-0 sticky-top" style="top: 90px; z-index: 1010;">
            <div class="card-body p-4">
                <div class="text-center mb-3">
                    {% set tax_rate = 0.10 %}
                    {% set service_fee_rate = 0.05 %}
                    {% set price_per_night_float = roomtype.price_per_night|float %}
                    {% set price_with_tax = price_per_night_float * (1 + tax_rate + service_fee_rate) %}
                    <div class="text-muted mb-1" style="font-size: 0.85rem;">${{ "{:,.2f}".format(price_with_tax) }} incl. tax</div>
                    <h3 class="text-success fw-bold mb-0">${{ "{:,.0f}".format(price_per_night_float) }}</h3>
                    <small class="text-muted">per night</small>
                </div>

                {% if current_user.is_authenticated and estimated_points_per_night > 0 %}
                <div class="text-center mb-3 p-3" style="background: #fef3c7; border-radius: 12px;">
                    <span class="text-dark" style="font-size: 0.9rem;">Earn <span class="fw-bold" style="font-size: 1.3rem; color: #d97706;">{{ "{:,}".format(estimated_points_per_night) }}</span> points per night</span>
                </div>
                {% endif %}

                <hr>

                <form action="{{ url_for('main.booking_confirm', roomtype_id=roomtype.id) }}" method="get">
                    {% set default_rooms = request.args.get('rooms_needed', 1) %}

                    <div class="mb-3">
                        <label class="form-label fw-bold">Check-in</label>
                        <input type="date" name="check_in" id="check_in" class="form-control" required value="{{ default_check_in }}" min="{{ today }}" onchange="updateCheckOutMin()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Check-out</label>
                        <input type="date" name="check_out" id="check_out" class="form-control" required value="{{ default_check_out }}" min="{{ today }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Rooms Required</label>
                        <input type="number" name="rooms_needed" class="form-control" min="1" value="{{ default_rooms }}" required>
                    </div>

                    {% if current_user.is_authenticated %}
                    <div class="d-grid">
                        <button type="submit" class="btn btn-lg fw-bold text-white" style="background: #1e3a8a; border: none;">Confirm Booking</button>
                    </div>
                    {% else %}
                    <div class="alert alert-secondary text-center">
                        Please <a href="{{ url_for('auth.login', next=request.url) }}" class="fw-bold">login</a> to book and earn points.
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function updateCheckOutMin() {
    const checkIn = document.getElementById('check_in');
    const checkOut = document.getElementById('check_out');
    if (checkIn.value) {
        // Set minimum check-out date to the day after check-in
        const checkInDate = new Date(checkIn.value);
        checkInDate.setDate(checkInDate.getDate() + 1);
        const minCheckOut = checkInDate.toISOString().split('T')[0];
        checkOut.min = minCheckOut;
        
        // If current check-out is before new minimum, update it
        if (checkOut.value && checkOut.value < minCheckOut) {
            checkOut.value = minCheckOut;
        }
    }
}
</script>
{% endblock %}
