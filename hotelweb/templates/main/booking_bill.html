{% extends "base.html" %}

{% block title %}Hotel Bill - {{ booking.room_type.hotel.name }}{% endblock %}


{% block content %}

<div class="bill-container">
    <div class="bill-header">
        <h1>{{ booking.room_type.hotel.name }}</h1>
        <div class="hotel-info">
            {{ booking.room_type.hotel.address }}<br>
            {{ booking.room_type.hotel.city }}
        </div>
    </div>

    <div class="bill-details">
        <div class="detail-section">
            <h3>Guest Information</h3>
            <div class="detail-item">
                <span class="detail-label">Name:</span>
                <span class="detail-value">{{ current_user.username }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Email:</span>
                <span class="detail-value">{{ current_user.email }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Confirmation #:</span>
                <span class="detail-value">{{ booking.id | string | upper }}</span>
            </div>
        </div>

        <div class="detail-section">
            <h3>Stay Details</h3>
            <div class="detail-item">
                <span class="detail-label">Check-in:</span>
                <span class="detail-value">{{ booking.check_in.strftime('%B %d, %Y') }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Check-out:</span>
                <span class="detail-value">{{ booking.check_out.strftime('%B %d, %Y') }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Nights:</span>
                <span class="detail-value">{{ nights }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Room Type:</span>
                <span class="detail-value">{{ booking.room_type.name }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Rooms:</span>
                <span class="detail-value">{{ booking.rooms_count }}</span>
            </div>
        </div>
    </div>

    <table class="charges-table">
        <thead>
            <tr>
                <th>Description</th>
                <th class="amount">Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <div class="bill-row-title">Room Rate</div>
                    <div class="bill-row-detail">
                        {{ booking.rooms_count }} room{{ 's' if booking.rooms_count > 1 else '' }} × {{ nights }}
                        night{{ 's' if nights > 1 else '' }} × ${{ "%.2f"|format(booking.base_rate) }}
                    </div>
                </td>
                <td class="amount">${{ "%.2f"|format(booking.subtotal) }}</td>
            </tr>
            {% if booking.breakfast_included %}
            <tr>
                <td>
                    <div class="bill-row-title">Breakfast Included</div>
                    <div class="bill-row-detail">
                        {{ booking.rooms_count }} room{{ 's' if booking.rooms_count > 1 else '' }} × ${{ "%.2f"|format(booking.breakfast_price_per_room) }}
                    </div>
                </td>
                <td class="amount">${{ "%.2f"|format(booking.breakfast_price_per_room * booking.rooms_count) }}</td>
            </tr>
            {% endif %}
            <tr>
                <td>Taxes (10%)</td>
                <td class="amount">${{ "%.2f"|format(booking.taxes) }}</td>
            </tr>
            <tr>
                <td>Service Fees (5%)</td>
                <td class="amount">${{ "%.2f"|format(booking.fees) }}</td>
            </tr>
            {% if booking.points_used > 0 %}
            <tr>
                <td>
                    <div class="bill-row-title">Points Redeemed</div>
                    <div class="bill-row-detail">
                        {{ "{:,}".format(booking.points_used) }} points (${{ "%.2f"|format(booking.points_used / 100) }})
                    </div>
                </td>
                <td class="amount cash-amount">-${{ "%.2f"|format(booking.points_used / 100) }}</td>
            </tr>
            {% endif %}
            <tr class="subtotal-row">
                <td><strong>Subtotal</strong></td>
                <td class="amount"><strong>${{ "%.2f"|format(booking.subtotal + booking.taxes + booking.fees + (booking.breakfast_price_per_room * booking.rooms_count if booking.breakfast_included else 0)) }}</strong></td>
            </tr>
            <tr class="total-row">
                <td><strong>Total Amount</strong></td>
                <td class="amount"><strong>${{ "%.2f"|format(booking.total_cost) }}</strong></td>
            </tr>
        </tbody>
    </table>

    <div class="payment-info">
        <h4>Payment Information</h4>
        <div class="payment-info-item">
            <span class="payment-label">Payment Method:</span>
            <span class="payment-value">
                {% if booking.payment_method == 'points' %}
                    Points Payment
                {% elif booking.payment_method == 'pay_at_hotel' %}
                    Pay at Hotel
                {% else %}
                    Paid Online
                {% endif %}
            </span>
        </div>
        <div class="payment-info-item">
            <span class="payment-label">Payment Status:</span>
            <span class="payment-value">
                {% if booking.payment_method == 'points' and booking.points_used >= booking.total_cost * 100 %}
                    Fully Paid
                {% elif booking.payment_method == 'pay_at_hotel' %}
                    Pending
                {% else %}
                    Paid
                {% endif %}
            </span>
        </div>
        {% if booking.points_used > 0 %}
        <div class="payment-info-item">
            <span class="payment-label">Points Used:</span>
            <span class="payment-value">{{ "{:,}".format(booking.points_used) }} points</span>
        </div>
        {% endif %}
    </div>

    {% if booking.points_earned > 0 %}
    <div class="points-section">
        <h3>Loyalty Points Earned</h3>
        <div class="points-amount">{{ "{:,}".format(booking.points_earned) }} Points</div>
        <p>Thank you for being a {{ current_user.membership_level }} member!</p>
        <p class="bill-points-note">
            Calculation: 1 dollar = 10 base points × {{ current_user.get_points_multiplier() }}x multiplier
            {% if booking.points_used > 0 %}
            <br>Note: Points earned on actual payment only (excludes amounts paid with points).
            {% endif %}
        </p>
    </div>
    {% elif booking.points_used > 0 and booking.points_used >= booking.total_cost * 100 %}
    <div class="points-section">
        <h3>Points Payment</h3>
        <div class="points-amount" style="font-size: 1.5rem;">Fully Paid with Points</div>
        <p class="bill-points-note">No points earned as booking was fully paid with points.</p>
    </div>
    {% endif %}

    <div class="bill-footer">
        <p><strong>Booking Confirmation #:</strong> {{ booking.id | string | upper }}</p>
        <p><strong>Booking Date:</strong> {{ booking.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
        <p class="bill-footer-thanks">Thank you for choosing {{ booking.room_type.hotel.name }}!</p>
        <p class="bill-footer-contact">For questions about this bill, please contact us at support@luminahotels.com</p>
    </div>

    <div class="action-buttons no-print">
        <button onclick="window.print()" class="bill-btn bill-btn-primary">Print Bill</button>
        <a href="{{ url_for('main.my_stays') }}" class="bill-btn bill-btn-outline">Back to My Stays</a>
    </div>
</div>
{% endblock %}